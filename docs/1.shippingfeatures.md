Delivery / Shipping Features — Backend API (Laravel)

This document describes the Delivery (pengiriman dokumen) backend API and related admin (Filament) resources implemented in the project.

Overview

-   Purpose: Accept delivery submissions from the Flutter courier app (sender/receiver/address/notes/photo) and provide CRUD endpoints for managing deliveries.
-   Auth: All delivery endpoints are protected by Laravel Sanctum (use Bearer token returned from /api/auth/login).
-   Storage: Uploaded photos are stored on the `public` disk and served via the storage symlink (run `php artisan storage:link` in deployment).

Repository locations (important files)

-   Migration: `database/migrations/2025_10_21_000000_create_deliveries_table.php`
-   Model: `app/Models/Delivery.php`
-   API Controller: `app/Http/Controllers/Api/DeliveryController.php`
-   Form Requests: `app/Http/Requests/StoreDeliveryRequest.php`, `app/Http/Requests/UpdateDeliveryRequest.php`
-   Routes: `routes/api.php` (protected group). Endpoint: `Route::apiResource('deliveries', DeliveryController::class);`
-   Filament Admin Resource: `app/Filament/Resources/DeliveryResource.php` (admin CRUD UI)

Database schema (deliveries table)

-   id (bigint, PK)
-   user_id (nullable, FK to users, nullOnDelete)
-   sender_name (string)
-   receiver_name (string)
-   address (text)
-   notes (text, nullable)
-   status (string, default: 'selesai')
-   photo (string, nullable) — stores path on `public` disk
-   created_at, updated_at

Eloquent model: `app/Models/Delivery.php`

-   $fillable: user_id, sender_name, receiver_name, address, notes, status, photo
-   Accessor: `photo_url` (appends `photo_url`), returns `Storage::url($this->photo)` or null
-   Relations: `user()` -> belongsTo User

API endpoints (base path: /api)
All endpoints below require the `Authorization: Bearer <token>` header (Sanctum token).

1. GET /api/deliveries

-   Description: List deliveries, paginated. Includes related user.
-   Query params:
    -   per_page (int) — number of items per page (default 15)
    -   my=true — optional; if provided and true, returns deliveries where user_id = authenticated user id
-   Response: paginated JSON with deliveries; each delivery includes `photo_url` attribute which is the publicly accessible URL.

2. GET /api/deliveries/{delivery}

-   Description: Show single delivery by id. Loads related user.
-   Response: delivery JSON (200)

3. POST /api/deliveries

-   Description: Create new delivery (multipart/form-data for photo)
-   Required headers: `Authorization: Bearer <token>` and `Content-Type: multipart/form-data` when uploading file
-   Request fields:
    -   sender_name (string, required, max 191)
    -   receiver_name (string, required, max 191)
    -   address (string, required)
    -   notes (string, optional)
-   status (string, optional) — defaults to 'selesai' (allowed: 'selesai')
-   photo (file, optional) — image, mimes: jpeg,png,jpg,webp, max 5120 KB
-   Behavior: If `photo` is present it's stored to `public` disk under `deliveries/` and the path saved to DB. `user_id` is set to the authenticated user when present.
-   Response: created delivery JSON (201)

4. PUT/PATCH /api/deliveries/{delivery}

-   Description: Update delivery. Ownership check: only owner or admin role can update.
-   Request fields: same validation as store, but fields are `sometimes|required` for string fields.
-   If updating photo: old photo on `public` disk will be deleted before saving new one.
-   Response: updated delivery JSON (200)

5. DELETE /api/deliveries/{delivery}

-   Description: Delete delivery. Ownership check: only owner or admin role can delete.
-   Behavior: deletes photo file from `public` disk (if exists) and deletes record.
-   Response: 204 No Content

Authentication flow (mobile app)

-   Login endpoint: POST /api/auth/login
    -   Expectation: returns a `plainTextToken` (Sanctum Token) on success. Use this as `Authorization: Bearer <token>` for subsequent calls.
-   For testing, feature tests create a user and use `actingAs($user, 'sanctum')`.

File storage and serving

-   Files are stored using `$request->file('photo')->store('deliveries', 'public')`.
-   To serve files, ensure the public `storage` symlink exists by running:

```powershell
php artisan storage:link
```

-   The `photo_url` accessor uses `Storage::url($path)` which uses `config/filesystems.php` `public` disk `url` (usually `APP_URL/storage`).

Filament admin notes

-   Admin CRUD for deliveries is under `app/Filament/Resources/DeliveryResource.php`.
-   The resource uses `FileUpload` for `photo` and shows columns: sender_name, receiver_name, status, created_at.
-   Make sure Filament role/permission (Filament Shield) settings allow the right roles to view/manage deliveries.

Note: the Filament list view was updated to include a `Photo` column (thumbnail) showing images stored on the `public` disk. The resource now uses an ImageColumn for `photo` so admins can quickly preview uploaded delivery photos in the list.

If you used the seeder/factory, generated deliveries may contain fake `photo` paths (e.g. `deliveries/##########.jpg`). To make thumbnails appear in the admin UI:

-   Ensure the public storage symlink exists:

```powershell
php artisan storage:link
```

-   Copy or place sample images into `storage/app/public/deliveries/` matching the seeded `photo` filenames; or update the DB rows to point to real files.

-   Alternatively, modify the factory to copy a placeholder image into the `public` disk when seeding so thumbnails are visible immediately.

Tests

-   Tests covering Delivery are in `tests/Feature/DeliveryTest.php` (uses Storage::fake('public') to test file upload).
-   The test suite in this workspace uses sqlite in-memory for PHPUnit per `phpunit.xml` adjustments.

Example curl requests

-   Create (with file):

```bash
curl -X POST "http://your-app.test/api/deliveries" \
  -H "Authorization: Bearer <token>" \
  -F "sender_name=Alice" \
  -F "receiver_name=Bob" \
  -F "address=Jl. Example 1" \
  -F "notes=Important docs" \
  -F "photo=@/path/to/photo.jpg"
```

-   List (my deliveries):

```bash
curl -X GET "http://your-app.test/api/deliveries?my=true&per_page=20" -H "Authorization: Bearer <token>"
```

-   Update (replace photo):

```bash
curl -X POST "http://your-app.test/api/deliveries/123?_method=PUT" \
  -H "Authorization: Bearer <token>" \
  -F "status=selesai" \
  -F "photo=@/path/to/new.jpg"
```

Deployment / production checklist

-   Ensure `APP_URL` is set and `public` disk URL is reachable (APP_URL/storage)
-   Run `php artisan storage:link` to serve photos
-   Configure disk (S3) if you prefer remote storage and update controller accordingly
-   Set appropriate file permissions for `storage` and `public/storage`

Appendix: Data shapes (examples)

-   Delivery JSON (example):

```json
{
    "id": 12,
    "user_id": 3,
    "sender_name": "Alice",
    "receiver_name": "Bob",
    "address": "Jl. Example 1",
    "notes": "Please sign",
    "status": "selesai",
    "photo": "deliveries/abcd1234.jpg",
    "photo_url": "https://your-app.test/storage/deliveries/abcd1234.jpg",
    "created_at": "2025-10-21T10:00:00.000000Z",
    "updated_at": "2025-10-21T10:00:00.000000Z"
}
```
